<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVD AI Chat Application</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>DVD AI Chat</h1>
            <p>Chat with DVD AI</p>
            <button id="clearAllButton" class="clear-all-button">Clear All</button>
        </header>

        <div class="chat-container" id="chatContainer">
                    <% if (history && history.length> 0) { %>
                        <% history.forEach(function(chat) { %>
                            <div class="message-group">
                                <div class="message user-message">
                                    <div class="message-header">You</div>
                                    <div class="message-content">
                                        <%= chat.userMessage %>
                                    </div>
                                    <div class="message-time">
                                        <%= new Date(chat.timestamp).toLocaleString() %>
                                    </div>
                                </div>
                                <div class="message bot-message">
                                    <div class="message-header">DVD AI</div>
                                    <div class="message-content">
                                        <%= chat.botResponse %>
                                    </div>
                                </div>
                            </div>
                            <% }); %>
                                <% } else { %>
                                    <div class="empty-state">
                                        <p>No messages yet. Start a conversation!</p>
                                    </div>
                                    <% } %>
        </div>

        <div class="input-container">
            <form id="chatForm">
                <input type="text" id="messageInput" name="message" placeholder="Type your message here..."
                    autocomplete="off" required>
                <button type="submit" id="sendButton">Send</button>
            </form>
        </div>
    </div>

    <script>
        // Handle form submission with fetch API
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const chatContainer = document.getElementById('chatContainer');
        const sendButton = document.getElementById('sendButton');

        chatForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const message = messageInput.value.trim();
            if (!message) return;

            // Disable input while processing
            messageInput.disabled = true;
            sendButton.disabled = true;
            sendButton.textContent = 'AI is thinking...';

            // Remove empty state if exists
            const emptyState = chatContainer.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            // Clear input
            messageInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                if (response.ok) {
                    // Create message group element
                    const messageGroup = document.createElement('div');
                    messageGroup.className = 'message-group';

                    // Create user message
                    const userMessage = document.createElement('div');
                    userMessage.className = 'message user-message';
                    userMessage.innerHTML = `
            <div class="message-header">You</div>
            <div class="message-content">${escapeHtml(data.userMessage)}</div>
            <div class="message-time">${new Date(data.timestamp).toLocaleString()}</div>
          `;

                    // Create bot message
                    const botMessage = document.createElement('div');
                    botMessage.className = 'message bot-message';
                    botMessage.innerHTML = `
            <div class="message-header">DVD AI</div>
            <div class="message-content">${escapeHtml(data.botResponse)}</div>
          `;

                    // Append messages
                    messageGroup.appendChild(userMessage);
                    messageGroup.appendChild(botMessage);
                    chatContainer.appendChild(messageGroup);

                    // Scroll to bottom
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            } finally {
                // Re-enable input
                messageInput.disabled = false;
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                messageInput.focus();
            }
        });

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-scroll to bottom on page load
        window.addEventListener('load', function () {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        // Focus input on page load
        messageInput.focus();

        // Handle clear all button
        const clearAllButton = document.getElementById('clearAllButton');
        clearAllButton.addEventListener('click', async function () {
            if (!confirm('Are you sure you want to clear all chat history? This cannot be undone.')) {
                return;
            }

            clearAllButton.disabled = true;
            clearAllButton.textContent = 'Clearing...';

            const response = await fetch('/chat/clear', {
                method: 'DELETE'
            });

            chatContainer.innerHTML = `
                <div class="empty-state">
                    <p>No messages yet. Start a conversation!</p>
                </div>
            `;

            clearAllButton.disabled = false;
            clearAllButton.textContent = 'Clear All';
        });
    </script>
</body>

</html>